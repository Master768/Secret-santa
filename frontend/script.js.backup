// State
let currentUser = null;
let currentRoom = null;
let ws = null;
let pollInterval = null;
let participantsExpanded = false;

// Emoji list
const emojis = ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‰', 'ğŸŠ', 'ğŸ', 'ğŸ„', 'ğŸ…', 'â›„', 'â„ï¸', 'â­', 'âœ¨', 'ğŸ’', 'â¤ï¸', 'ğŸ’š', 'ğŸˆ', 'ğŸ”¥', 'ğŸ’¯', 'ğŸ‘Œ', 'âœ…', 'ğŸ¯', 'ğŸ†'];

// Icons
lucide.createIcons();

// Snow Effect
function createSnow() {
    const container = document.getElementById('snow-container');
    if (!container) return;
    for (let i = 0; i < 50; i++) {
        const flake = document.createElement('div');
        flake.className = 'snowflake';
        flake.innerHTML = 'â„';
        flake.style.left = Math.random() * 100 + 'vw';
        flake.style.animationDuration = (Math.random() * 5 + 5) + 's';
        flake.style.opacity = Math.random();
        flake.style.fontSize = (Math.random() * 10 + 10) + 'px';
        container.appendChild(flake);
    }
}
createSnow();

// Countdown Animation
async function showCountdown() {
    const overlay = document.getElementById('countdown-overlay');
    const number = document.getElementById('countdown-number');

    overlay.classList.remove('hidden');

    for (let i = 5; i >= 1; i--) {
        number.textContent = i;
        number.style.animation = 'none';
        setTimeout(() => { number.style.animation = 'countdown-pulse 1s ease-in-out'; }, 10);
        await new Promise(resolve => setTimeout(resolve, 1000));
    }

    number.textContent = 'ğŸ‰';
    await new Promise(resolve => setTimeout(resolve, 1000));

    overlay.classList.add('hidden');
}

// Poll Functions
function openPollModal() {
    document.getElementById('poll-modal').classList.remove('hidden');
}

function closePollModal() {
    document.getElementById('poll-modal').classList.add('hidden');
    document.getElementById('poll-question').value = '';
    const container = document.getElementById('poll-options-container');
    container.innerHTML = `
        <input type="text" class="poll-option-input w-full bg-white border border-gray-300 rounded-xl p-3 text-sm focus:outline-none focus:border-red-500" placeholder="Option 1">
        <input type="text" class="poll-option-input w-full bg-white border border-gray-300 rounded-xl p-3 text-sm focus:outline-none focus:border-red-500" placeholder="Option 2">
    `;
}

function addPollOption() {
    const container = document.getElementById('poll-options-container');
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'poll-option-input w-full bg-white border border-gray-300 rounded-xl p-3 text-sm focus:outline-none focus:border-red-500';
    input.placeholder = `Option ${container.children.length + 1}`;
    container.appendChild(input);
}

    } catch (e) {
    alert(e.message);
}
}

async function joinRoom() {
    const codeInput = document.getElementById('join-code');
    const nameInput = document.getElementById('join-name');
    const prefInput = document.getElementById('join-pref');
    const secretInput = document.getElementById('join-secret');

    const code = codeInput.value.trim().toUpperCase();
    const name = nameInput.value.trim();
    const pref = prefInput.value.trim();
    const secret = secretInput.value.trim();

    if (!code || !name) return alert('Please fill in all fields');

    try {
        const participant = await apiCall('/rooms/join', 'POST', {
            room_code: code,
            name,
            preferences: pref,
            secret_message: secret
        });
        currentUser = participant;
        currentRoom = await apiCall(`/rooms/${code}`);
        enterLobby();
    } catch (e) {
        alert(e.message);
    }
}

async function startGame() {
    if (!currentRoom || !currentUser.is_host) return;

    // Show countdown
    await showCountdown();

    try {
        const res = await apiCall(`/rooms/${currentRoom.code}/start`, 'POST');
        updateGameState(res.participants, true);
    } catch (e) {
        alert(e.message);
    }
}

async function closeRoom() {
    if (!currentRoom || !currentUser.is_host) return;
    if (!confirm("Are you sure you want to close this room? This will delete all data permanently.")) return;

    try {
        await apiCall(`/rooms/${currentRoom.code}`, 'DELETE');
        alert("Room closed and data deleted.");
        window.location.reload();
    } catch (e) {
        alert("Failed to close room: " + e.message);
    }
}

// Utilities
function copyCode() {
    const code = document.getElementById('lobby-code').innerText;
    navigator.clipboard.writeText(code).then(() => {
        alert('Room code copied to clipboard!');
    });
}

function downloadCard() {
    const card = document.getElementById('card-content');
    if (!card) return;

    html2canvas(card, {
        backgroundColor: '#f0fdf4',
        scale: 2
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = `secret-santa-${document.getElementById('match-name').innerText}.png`;
        link.href = canvas.toDataURL();
        link.click();
    });
}
